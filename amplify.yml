version: 1
applications:
  - frontend:
      # ç¯å¢ƒå˜é‡ç›´æ¥åœ¨è¿™é‡Œå®šä¹‰
      environmentVariables:
        # === åº”ç”¨ç¯å¢ƒå˜é‡ ===
        NODE_ENV: production
        REACT_APP_API_URL: https://rsyfaexhi7.execute-api.us-east-1.amazonaws.com/dev
        
        # === æ„å»ºä¼˜åŒ–å˜é‡ ===
        NODE_OPTIONS: --max-old-space-size=4096
        
        # === NPM é…ç½®å˜é‡ ===
        NPM_CONFIG_LEGACY_PEER_DEPS: true
        NPM_CONFIG_ENGINE_STRICT: false
        NPM_CONFIG_FUND: false
        NPM_CONFIG_AUDIT_LEVEL: moderate
        
        # === æ€§èƒ½ä¼˜åŒ–å˜é‡ ===
        DISABLE_ESLINT_PLUGIN: true
        GENERATE_SOURCEMAP: false
        SKIP_PREFLIGHT_CHECK: true
        FAST_REFRESH: true
        
      phases:
        preBuild:
          commands:
            # ç¯å¢ƒä¿¡æ¯æ˜¾ç¤º
            - echo "=== ğŸ” æ„å»ºç¯å¢ƒä¿¡æ¯ ==="
            - echo "Node.js version:" && node --version
            - echo "NPM version:" && npm --version
            - echo "Current directory:" && pwd
            - echo "Environment variables:"
            - echo "NODE_ENV=$NODE_ENV"
            - echo "REACT_APP_API_URL=$REACT_APP_API_URL"
            - echo "NODE_OPTIONS=$NODE_OPTIONS"
            
            # è®¾ç½® NPM é…ç½®
            - echo "=== âš™ï¸  é…ç½® NPM ==="
            - npm config set fund false
            - npm config set audit-level moderate
            - npm config set engine-strict false
            - npm config set legacy-peer-deps true
            - npm config set registry https://registry.npmjs.org/
            
            # æ¸…ç†ç¼“å­˜
            - echo "=== ğŸ§¹ æ¸…ç†ç¼“å­˜ ==="
            - npm cache clean --force || echo "Cache clean warning - continuing..."
            
            # æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
            - echo "=== ğŸ“‹ é¡¹ç›®ä¿¡æ¯ ==="
            - echo "Package.jsonæ£€æŸ¥:"
            - ls -la package.json
            - echo "Build script:" && (cat package.json | grep '"build"' || echo "No build script found")
            
            # æ™ºèƒ½ä¾èµ–å®‰è£…
            - echo "=== ğŸ“¦ å®‰è£…ä¾èµ– ==="
            - |
              echo "å¼€å§‹å®‰è£…ä¾èµ–..."
              if [ -f package-lock.json ]; then
                echo "Found package-lock.json, trying npm ci first..."
                if npm ci --legacy-peer-deps --production=false; then
                  echo "âœ… npm ci æˆåŠŸ"
                else
                  echo "âŒ npm ci å¤±è´¥ï¼Œfallback to npm install"
                  rm -f package-lock.json
                  npm install --legacy-peer-deps
                fi
              else
                echo "No package-lock.json, using npm install..."
                npm install --legacy-peer-deps
              fi
            
            # éªŒè¯å®‰è£…ç»“æœ
            - echo "=== âœ… éªŒè¯ä¾èµ–å®‰è£… ==="
            - |
              if [ -d "node_modules" ]; then
                echo "âœ… node_modules ç›®å½•å­˜åœ¨"
                echo "ä¾èµ–åŒ…æ•°é‡: $(ls node_modules | wc -l 2>/dev/null || echo 'Unknown')"
              else
                echo "âŒ node_modules ç›®å½•ä¸å­˜åœ¨!"
                exit 1
              fi
            
            # æ£€æŸ¥å…³é”®ä¾èµ–ï¼ˆéé˜»å¡ï¼‰
            - echo "æ£€æŸ¥å…³é”®ä¾èµ–:"
            - npm list react react-dom next --depth=0 || echo "âš ï¸  æŸäº›ä¾èµ–å¯èƒ½æœ‰ç‰ˆæœ¬é—®é¢˜ï¼Œä½†ç»§ç»­æ„å»º"
            
        build:
          commands:
            - echo "=== ğŸ”¨ å¼€å§‹æ„å»º ==="
            - echo "ç¡®è®¤ç¯å¢ƒå˜é‡:"
            - echo "NODE_ENV: $NODE_ENV"
            - echo "REACT_APP_API_URL: $REACT_APP_API_URL"
            - echo "NODE_OPTIONS: $NODE_OPTIONS"
            
            # æ˜¾ç¤ºå†…å­˜ä¿¡æ¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            - echo "ç³»ç»Ÿèµ„æºä¿¡æ¯:"
            - free -h 2>/dev/null || echo "å†…å­˜ä¿¡æ¯ä¸å¯ç”¨"
            - df -h . 2>/dev/null || echo "ç£ç›˜ä¿¡æ¯ä¸å¯ç”¨"
            
            # æ‰§è¡Œæ„å»º
            - echo "æ‰§è¡Œæ„å»ºå‘½ä»¤: npm run build"
            - npm run build
            
            # æ„å»ºç»“æœéªŒè¯
            - echo "=== âœ… æ„å»ºç»“æœéªŒè¯ ==="
            - echo "æ„å»ºå®Œæˆï¼Œæ£€æŸ¥è¾“å‡ºç›®å½•:"
            - ls -la
            - |
              # æ™ºèƒ½æ£€æµ‹æ„å»ºè¾“å‡ºç›®å½•
              BUILD_SUCCESS=false
              
              if [ -d "out" ]; then
                echo "âœ… æ‰¾åˆ° out/ ç›®å½• (Next.js static export)"
                echo "æ–‡ä»¶æ•°é‡: $(find out -type f 2>/dev/null | wc -l)"
                echo "ç›®å½•å¤§å°: $(du -sh out/ 2>/dev/null || echo 'å¤§å°è®¡ç®—å¤±è´¥')"
                echo "ä¸»è¦æ–‡ä»¶:"
                ls -la out/ | head -10
                if [ -f "out/index.html" ]; then
                  echo "âœ… æ‰¾åˆ° index.html"
                  BUILD_SUCCESS=true
                else
                  echo "âš ï¸  æœªæ‰¾åˆ° index.html"
                fi
                
              elif [ -d "build" ]; then
                echo "âœ… æ‰¾åˆ° build/ ç›®å½• (Create React App)"
                echo "æ–‡ä»¶æ•°é‡: $(find build -type f 2>/dev/null | wc -l)"
                echo "ç›®å½•å¤§å°: $(du -sh build/ 2>/dev/null || echo 'å¤§å°è®¡ç®—å¤±è´¥')"
                echo "ä¸»è¦æ–‡ä»¶:"
                ls -la build/ | head -10
                if [ -f "build/index.html" ]; then
                  echo "âœ… æ‰¾åˆ° index.html"
                  BUILD_SUCCESS=true
                else
                  echo "âš ï¸  æœªæ‰¾åˆ° index.html"
                fi
                
              elif [ -d "dist" ]; then
                echo "âœ… æ‰¾åˆ° dist/ ç›®å½• (Vite/Vue/å…¶ä»–)"
                echo "æ–‡ä»¶æ•°é‡: $(find dist -type f 2>/dev/null | wc -l)"
                echo "ç›®å½•å¤§å°: $(du -sh dist/ 2>/dev/null || echo 'å¤§å°è®¡ç®—å¤±è´¥')"
                echo "ä¸»è¦æ–‡ä»¶:"
                ls -la dist/ | head -10
                if [ -f "dist/index.html" ]; then
                  echo "âœ… æ‰¾åˆ° index.html"
                  BUILD_SUCCESS=true
                else
                  echo "âš ï¸  æœªæ‰¾åˆ° index.html"
                fi
                
              else
                echo "âŒ æœªæ‰¾åˆ°ä»»ä½•æ„å»ºè¾“å‡ºç›®å½•!"
                echo "å½“å‰ç›®å½•å†…å®¹:"
                ls -la
                echo "è¯·æ£€æŸ¥æ„å»ºé…ç½®"
                exit 1
              fi
              
              if [ "$BUILD_SUCCESS" = true ]; then
                echo "âœ… æ„å»ºéªŒè¯æˆåŠŸ"
              else
                echo "âš ï¸  æ„å»ºå¯èƒ½æœ‰é—®é¢˜ï¼Œä½†å°è¯•ç»§ç»­"
              fi
              
        postBuild:
          commands:
            - echo "=== ğŸ‰ æ„å»ºå®Œæˆ ==="
            - echo "å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
            - |
              # æœ€ç»ˆæ£€æŸ¥å’ŒæŠ¥å‘Š
              echo "=== ğŸ“Š æ„å»ºæŠ¥å‘Š ==="
              if [ -d "out" ]; then
                echo "éƒ¨ç½²ç›®å½•: out/"
                echo "HTMLæ–‡ä»¶: $(find out -name "*.html" | wc -l)"
                echo "JSæ–‡ä»¶: $(find out -name "*.js" | wc -l)"
                echo "CSSæ–‡ä»¶: $(find out -name "*.css" | wc -l)"
              elif [ -d "build" ]; then
                echo "éƒ¨ç½²ç›®å½•: build/"
                echo "HTMLæ–‡ä»¶: $(find build -name "*.html" | wc -l)"
                echo "JSæ–‡ä»¶: $(find build -name "*.js" | wc -l)"
                echo "CSSæ–‡ä»¶: $(find build -name "*.css" | wc -l)"
              elif [ -d "dist" ]; then
                echo "éƒ¨ç½²ç›®å½•: dist/"
                echo "HTMLæ–‡ä»¶: $(find dist -name "*.html" | wc -l)"
                echo "JSæ–‡ä»¶: $(find dist -name "*.js" | wc -l)"
                echo "CSSæ–‡ä»¶: $(find dist -name "*.css" | wc -l)"
              fi
            - echo "ğŸš€ å‡†å¤‡éƒ¨ç½²åˆ° Amplify!"
            
      artifacts:
        # ğŸ”„ æ ¹æ®ä½ çš„æ„å»ºè¾“å‡ºè°ƒæ•´è¿™é‡Œ
        # å¦‚æœæ˜¯ build/ ç›®å½•ï¼Œæ”¹ä¸º build
        # å¦‚æœæ˜¯ dist/ ç›®å½•ï¼Œæ”¹ä¸º dist
        baseDirectory: build
        files:
          - '**/*'
        excludePaths:
          - node_modules/**/*
          - .git/**/*
          - .env*
          - '*.log'
          - package-lock.json
          - '*.map'
          
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
          - .npm/**/*
          
    appRoot: ./